plugins {
  id 'java-library'
  id 'com.bmuschko.izpack' version '3.0'
  id 'com.github.ben-manes.versions' version '0.28.0'
  id 'net.nemerosa.versioning' version '2.13.1'
}

ext {
  installerRes = file("$buildDir/installer.res")
}

repositories {
  mavenLocal()
  mavenCentral()
}

sourceSets.main.resources {
  exclude "**/izpack/*"
}

configurations {
  izpack
  installer
}

dependencies {
  izpack "org.codehaus.izpack:izpack-ant:${rev_izpack}"

  implementation "org.codehaus.izpack:izpack-api:${rev_izpack}"
  implementation "org.codehaus.izpack:izpack-core:${rev_izpack}"
  implementation "org.codehaus.izpack:izpack-panel:${rev_izpack}"

  testImplementation "org.junit.jupiter:junit-jupiter-api:${rev_junit_jupiter}"
  testImplementation "org.junit.jupiter:junit-jupiter-migrationsupport:${rev_junit_jupiter}"
  testRuntimeOnly "org.junit.jupiter:junit-jupiter-engine:${rev_junit_jupiter}"
  testRuntimeOnly "org.junit.platform:junit-platform-runner:${rev_junit_platform}"
  testRuntimeOnly "org.junit.vintage:junit-vintage-engine:${rev_junit_jupiter}"

  installer configurations.compile
}

test {
  useJUnitPlatform()
  jvmArgs '-Duser.language=de', '-Duser.country=CH', '-Duser.timezone=Europe/Berlin', '-XX:-TieredCompilation'
}

dependencyUpdates.resolutionStrategy {
  componentSelection { rules ->
    rules.all { ComponentSelection selection ->
      boolean rejected = ['alpha', 'beta', 'rc', 'cr', 'm', 'preview', 'b', 'pr', 'ea'].any { qualifier ->
        selection.candidate.version ==~ /(?i).*[.-]${qualifier}[.\d-+]*/
      }
      if (rejected) {
        selection.reject('Release candidate')
      }
    }
  }
}

izpack {
  baseDir = file("src/main/izpack")
  compression = 'deflate'
  compressionLevel = 9
  appProperties = ['copyright.holder': 'Patrick Reinhart',
                   'copyright.email': 'patrick@reini.net',
                   'copyright.year': '2019',
                   'product.name': 'izPack Demo Product', 
                   'product.version' : version,
                   'product.url' : 'http://www.reini.net',
                   'product.subpath': 'izPackDemoProduct',
                   'install.res': installerRes,
                   'install.jar': file("$buildDir/libs/izPackDemoInstaller-${version}.jar")]
}

izPackCreateInstaller.dependsOn  = ['jar']

defaultTasks 'izPackCreateInstaller'
